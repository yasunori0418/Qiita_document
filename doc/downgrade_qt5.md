# Qt5.15.6で動かない…だと…(Archlinuxで複数パッケージをダウングレードするワンライナー)

Arch Linuxをいつものように使っていて、あるときいくつかのアプリケーションが動かないことに気がつきました。
今回は動かなかったfcitx5を代表例として、ターミナルから起動させてみました。

```bash:terminal
$ fcitx5-configtool
Cannot mix incompatible Qt library (5.15.5) with this library (5.15.6)
[1]    41884 IOT instruction (core dumped)  fcitx5-configtool
```

> 互換性のない Qt ライブラリ (5.15.5) をこのライブラリ (5.15.6) と混在させることはできません。

どうやら、Qt5のライブラリに`5.15.(5|6)`が混在するせいで、うまく動かないようです。
ですので、Qt5のライブラリで`5.15.6`をグレードダウンさせて、`5.15.5`に統一することで解決します。

## TL;DR

解決手段として、AURに`downgrade`というツールがありますので、そちらを使用します。
また、ダウングレードするパッケージ量が多いので、パッケージの指定方法をワンラインで解決してみました。

```bash:terminal
paru -S downgrade     # downgradeをAURヘルパーでインストールします。
paru -Qs qt5 | rg '5.15.6' | sed -r "s/local\///g" | awk -F'[ ]' '{print $1}' | tr '\n' ' ' > pkglist.txt && sudo downgrade `cat pkglist.txt` && rm pkglist.txt
```

---

**今回のコマンドで、注意してほしいこと。**
- AURヘルパーには`paru`を使用していますが、ほかのAURヘルパーでも問題なく動くかと思います。
- `downgrade`でのダウングレードバージョンの指定方法は、`fzf`でインクリメントサーチすることになるので、パッケージの数だけ都度指定する必要があります。
- `downgrade`ではダウングレードしたパッケージを`pacman.conf`の`IgnorPkg`に追加する機能もありますが、コマンド終了後に`pacman.conf`を確認した方が良いです。
    - `IgnorePkg`への指定されているパッケージリストが酷いことになります。

あとは、ワンラインで何をやっているのかの解説になります。
よろしければ最後までお付き合いください。


## downgradeについて

Arch Linuxにおけるパッケージ管理ツールである`pacman`は最新のパッケージの更新のみで、ダウングレードやバージョン指定のインストールなどには対応していません。
もし不具合などでパッケージのダウングレードをしたい場合は、インストール時に`/var/lib/pacman/local`下へキャッシュされるパッケージを`sudo pacman -U`を使用して解決できます。
そのうえで`/etc/pacman.conf`の`IgnorePkg`へ、更新を無効にするパッケージ名を追記することでダウングレードが完了します。

このダウングレード作業が1～2回くらいならどうってことはないのですが、10を超えてくると作業量はたいへんなものになってしまいます。
それをお手軽にパッケージ指定して解決できるのが、この`downgrade`です。

https://github.com/archlinux-downgrade/downgrade

処理的には`pacman`をラップして、ローカルキャッシュとALA（Arch Linux Archive）と呼ばれるオンラインで保管されている過去バージョンのパッケージを`fzf`で検索してダウングレードを行います。
ダウングレード完了後はインタラクティブに`IgnorePkg`へ追記するか確認してくれるので、必要であれば`y`を選択して追記してもらいましょう。

今回はダウングレードするパッケージをすべて`IgnorePkg`へ追記してもらいました。

## 対象のパッケージを絞り込む

`pacman`やそれをラップしているAURヘルパーでは`-Qs`でインストール済みのパッケージを検索できます。
今回はタイプ量が減るので`paru`から検索してみました。

その検索結果にはデフォルトで、以下のようなフォーマットで出力されます。

```
local/パッケージ名 パッケージバージョン パッケージグループ
    パッケージ説明
```

この検索結果を標準入力で`ripgrep`に渡して、検索対象のバージョンを指定します。
これは`grep`でも可能ですね。皆さんもターミナルで検索するときは良くやると思います。

```
paru -Qs qt5 | rg '5.15.6'
```

これで`paru`からの検索結果をバージョン指定して、パッケージリストの一行目のパッケージ名やバージョンが書いてある部分だけのリストを取得できました。

## 必要なところだけを抽出して整形する



## downgradeに引数として渡す



## まとめ



